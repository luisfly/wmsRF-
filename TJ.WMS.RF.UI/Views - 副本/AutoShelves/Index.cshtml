@{
    ViewBag.Title = "指示上架";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<div class="box">
   <table cellspacing="1" cellpadding="0">
        <tr >
           <td class="title">收货托盘</td>
           <td class="content" ><input id="txtTrayNO" name="txtTrayNO" type="text" class="tdInput"  /></td>
        </tr>
       <tr>
          <td class="title">目标储位</td>
          <td class="content" id="lblTargetLocationNO"></td>
       </tr>
       <tr>
          <td class="title">储位效验</td>
          <td class="content"><input id="txtLocationNO" name="txtLocationNO" type="text" class="tdInput" /></td>
       </tr>
  </table>
</div>
<div class="btn">
  <input  type="button" value="上架(F8)" id="btnShelves" onclick="ValidateLocationNO()" /> 
  <input  type="button" id="btnNext" onclick="GetNextShelvesLocationNO()"   value="取下一储位(F9)"/>
</div>
      <div class="detail">
         <table style="display:none" id="ShelvesDetail" cellpadding="0px" cellspacing="1px" border="0px">
           <thead>
             <tr class="title">
             <th>商品条码</th>
             <th>商品名称</th>
             <th>单位</th>
             <th>数量</th>
             </tr>
           </thead>
           <tbody>
             @* <tr>
                  <td>&nbsp;</td>
                  <td>&nbsp;</td>
                  <td>&nbsp;</td>
              </tr>*@
           </tbody>
         </table>
      </div>

<script  type="text/javascript">
    $(document).ready(function () {
        $(document).keydown(function (e) {
            var elem = e.srcElement || e.target;
            if (e.which == 119)//F8
            {
                ValidateLocationNO();
            }
            else if (e.which == 120)//F9
            {
                GetNextShelvesLocationNO();
            }
        });

        $("#txtTrayNO").keypress(function (e) {
            if (e.which == 13) {
                ValidateTrayNO();
            }
        }).blur();

        $("#txtLocationNO").keypress(function (e) {
            if (e.which == 13) {
                ValidateLocationNO();
            }
        }).blur();
        $("#txtLocationNO").attr("disabled", "disabled");
        $("#txtTrayNO").focus();
    });


    function SetParams() {
        var params = {
            "model.TrayNO": $("#txtTrayNO").val(),
            "model.TargetLocationNO": $("#lblTargetLocationNO").text(),
            "model.LocationNO": $("#txtLocationNO").val()
        }
        return params;
    }

    function ValidateTrayNO() {
        $("#Loading").css("visibility", "visible");
     
        $("#SuccessMsg").css("visibility", "hidden");
        $("#SuccessMsg").html("");
        $("#Msg").css("visibility", "hidden");
        $("#Msg").html("");
        var url = "/AutoShelves/ValidateTrayNO";
        var params = SetParams();
        $.post(url, params, function (data, textStatus) {
            if (data != "") {
                $("#Msg").css("visibility", "hidden");
                $("#Msg").html("");
                var dataObj;
                try {
                    dataObj = eval(data);
                    if (dataObj != undefined) {
                        $("#ShelvesDetail").css("visibility", "visible");
                        $("#ShelvesDetail").css("display", "block");
                        if (dataObj.length > 0) {
                            var tmp = "<tr>";
                            tmp += "<td>" + dataObj[0].Barcode;
                            tmp += "</td>"
                            tmp += "<td>" + dataObj[0].GoodsDesc;
                            tmp += "</td>"
                            tmp += "<td>" + dataObj[0].Unit;
                            tmp += "</td>"
                            tmp += "<td>" + dataObj[0].Qty;
                            tmp += "</td>"
                            tmp += "</tr>"
                            $("#ShelvesDetail tbody").html(tmp);
                        }
                        $("#Loading").css("visibility", "hidden");
                        //$("#txtLocationNO").attr("disabled", "");
                        //$("#txtLocationNO").focus();
                        //$("#txtLocationNO").select();
                        GetShelvesLocationNO();
                    }
                }
                catch (exception) {
                    $("#ShelvesDetail").css("visibility", "hidden");
                    $("#Loading").css("visibility", "hidden");
                    $("#ShelvesDetail tbody").html("");
                    $("#Msg").css("visibility", "visible");
                    $("#Msg").html(data);
                    $("#txtTrayNO").focus();
                    $("#txtTrayNO").select();
                    $("#txtLocationNO").attr("disabled", "disabled");
                    $("#txtLocationNO").val("");
                    $("#lblTargetLocationNO").text("");
                }
                return false;
            }
            else {
                $("#ShelvesDetail").css("visibility", "hidden");
                $("#Msg").css("visibility", "hidden");
                $("#Msg").html("");
                $("#txtLocationNO").attr("disabled", "");
                $("#txtLocationNO").focus();
                $("#txtLocationNO").select();
            }

        }
    );
    }

    function GetShelvesLocationNO() {
        $("#Loading").css("visibility", "visible");
        $("#SuccessMsg").css("visibility", "hidden");
        $("#SuccessMsg").html("");
        $("#Msg").css("visibility", "hidden")
        $("#Msg").html("");
        var url = "/AutoShelves/GetShelvesLocationNO";
        var params = SetParams();
        $.post(url, params, function (data, txtStatus) {
            if (data != "") {
                //alert(data);
                var dataObj;
                try {
                    dataObj = eval(data);
                    
                    if (dataObj != undefined) {
                        if (dataObj.length <= 0) { return false; }
                        for (var index in dataObj) {
                            $("#lblTargetLocationNO").text(dataObj[index].ToLocationNO);
                        }
                        $("#Loading").css("visibility", "hidden");
                        $("#Msg").css("visibility", "hidden");
                        $("#Msg").html("");
                        $("#txtLocationNO").attr("disabled", "");
                        $("#txtLocationNO").focus();
                        $("#txtLocationNO").select();
                    }
                }
                catch (exception) {
                    $("#Loading").css("visibility", "hidden");
                    $("#Msg").css("visibility", "visible")
                    $("#Msg").html(data);
                    $("#txtTrayNO").select();
                    $("#lblTargetLocationNO").text("");
                }
            }
            else {
                $("#Loading").css("visibility", "hidden");
                $("#Msg").css("visibility", "visible")
                $("#Msg").html(data);
                $("#txtTrayNO").select();
                $("#lblTargetLocationNO").text("");
            }
        })
    }

    function GetNextShelvesLocationNO() {
        $("#Loading").css("visibility", "visible");
        $("#SuccessMsg").css("visibility", "hidden");
        $("#SuccessMsg").html("");
        $("#Msg").css("visibility", "hidden")
        $("#Msg").html("");
        var url = "/AutoShelves/GetNextShelvesLocationNO";
        var params = SetParams();
        $.post(url, params, function (data, txtStatus) {
            if (data != "") {
                //alert(data);
                var dataObj;
                try {
                    dataObj = eval(data);

                    if (dataObj != undefined) {
                        if (dataObj.length <= 0) { return false; }
                        for (var index in dataObj) {
                            $("#lblTargetLocationNO").text(dataObj[index].ToLocationNO);
                        }
                        $("#Loading").css("visibility", "hidden");
                        $("#Msg").css("visibility", "hidden");
                        $("#Msg").html("");
                        $("#txtLocationNO").attr("disabled", "");
                        $("#txtLocationNO").focus();
                        $("#txtLocationNO").select();
                    }
                }
                catch (exception) {
                    $("#Loading").css("visibility", "hidden");
                    $("#Msg").css("visibility", "visible")
                    $("#Msg").html(data);
                    $("#txtTrayNO").select();
                    $("#lblTargetLocationNO").text("");
                }
            }
            else {
                $("#Loading").css("visibility", "hidden");
                $("#Msg").css("visibility", "visible")
                $("#Msg").html(data);
                $("#txtTrayNO").select();
                $("#lblTargetLocationNO").text("");
            }
        })
    }

    function ValidateLocationNO() {
        $("#Loading").css("visibility", "visible");
        $("#SuccessMsg").css("visibility", "hidden");
        $("#SuccessMsg").html("");
        $("#Msg").css("visibility", "hidden");
        $("#Msg").html("");
        if ($("#lblTargetLocationNO").text() != $("#txtLocationNO").val()) {
            $("#Loading").css("visibility", "hidden");
            $("#Msg").css("visibility", "visible");
            $("#Msg").html("效验储位失败！");
            $("#txtLocationNO").focus();
            $("#txtLocationNO").select();
            return false;
        }
        var url = "/AutoShelves/ValidateLocationNO";
        var params = SetParams();
        $.post(url, params, function (data, txtStatus) {
                if (data != "") {
                    $("#Loading").css("visibility", "hidden");
                    $("#Msg").css("visibility", "visible");
                    $("#Msg").html(data);
                    $("#txtLocationNO").focus();
                    $("#txtLocationNO").select();
                    return false;
                }
                else {
                    $("#Loading").css("visibility", "hidden");
                    $("#ShelvesDetail tbody").html("");
                    $("#ShelvesDetail").css("visibility", "hidden");
                    $("#Msg").css("visibility", "hidden");
                    $("#Msg").html("");
                    $("#txtTrayNO").val("");
                    $("#txtLocationNO").val("");
                    $("#lblTargetLocationNO").text("");
                    $("#SuccessMsg").html("操作成功！");
                    $("#SuccessMsg").css("visibility", "visible");
                    $("#txtTrayNO").focus();
                    $("#txtLocationNO").attr("disabled", "disabled");
                    return true;
                }

            }
    );
    }
</script>  


