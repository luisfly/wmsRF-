@{
    ViewBag.Title = "撤消装载";
    Layout = "~/Views/Shared/_LayoutDetail.cshtml";
    DataTable dt = ViewBag.data;
    Boolean dtEmpty = (dt == null || dt.Rows.Count == 0);

}
@using System.Data;
<input id="dtEmpty" type="hidden" value="@dtEmpty" />
@if (!dtEmpty)
{
    <input id="hdPaperNO" type="hidden" value="@dt.Rows[0]["PaperNO"]" />
    <div class="box">
        <table cellpadding="0" cellspacing="1">
            <tr>
                <td class="title">装载号</td>
                <td class="content" id="lblLoadNO">@dt.Rows[0]["LoadNO"]</td>
            </tr>
            @*<tr>
                <td class="title">装载单号</td>
                <td class="content" id="lblPaperNO">@dt.Rows[0]["PaperNO"]</td>
            </tr>*@
            <tr>
                <td class="title">门店编码</td>
                <td class="content" id="lblStoreNO">@dt.Rows[0]["StoreNO"]</td>
            </tr>
            <tr>
                <td class="title">门店名称</td>
                <td class="content" id="lblStoreName">@dt.Rows[0]["StoreDesc"]</td>
            </tr>
            <tr>
                <td class="title">出库箱</td>
                <td class="content">
                    <input type="text" name="txtTrayNO" id="txtTrayNO" class="tdInput" />
                </td>
            </tr>
        </table>
    </div>
    <div class="btn">
        <input type="button" value="撤消(F8)" id="btnUnLoad" onclick="UnLoad()"/>
        @*<input type="button" value="返回(F9)" id="btnBack" onclick="javascript: history.back(-1);"/>*@
    </div>
    <div class="goodsquery">
        <table id="tbMainQuery">
            <thead>
                <tr>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
}
<script type="text/javascript">
    $(document).ready(function () {
        if ($("#dtEmpty").val() == "") {
            $("#Loading").css("visibility", "hidden");
            $("#Msg").css("visibility", "visible");
            $("#Msg").html("装载单无效，正在跳转...");
            Pause(this, 500); //调用暂停函数
            this.NextStep = function () {
                document.location.href = "/Load";
            }
        }
        $(document).keydown(function (e) {
            var elem = e.srcElement || e.target;
            if (e.which == 119)//F8
            {
                UnLoad();
            }
            if (e.which == 120)//F9
            {
                $("#btnBack").click();
            }
//            if (e.which == 118)//F7
//            {
//                $("#btnCntainerSend").click();
//            }
        });

        $("#txtTrayNO").keypress(function (e) {
            if (e.which == 13) {
                QryLoadTrayGoods();
            }
        }).blur();
        $("#txtTrayNO").focus();
    });


    //=====================================================
    function SetParmas() {
        var params = {
            "PaperNO": $("#hdPaperNO").val(),
            "StoreNO": $("#lblStoreNO").text(),
            "TrayNO": $("#txtTrayNO").val()
        };
        return params;
    }

    function QryLoadTrayGoods() {
        $("#Loading").css("visibility", "visible");
        $("#SuccessMsg").css("visibility", "hidden");
        $("#SuccessMsg").html("");
        $("#Msg").css("visibility", "hidden");
        $("#Msg").html("");
        $("#tbMainQuery thead").html("");
        $("#tbMainQuery tbody").html("");
        $.post("/Load/QryLoadTrayGoods",
               SetParmas(),
           function (data, textStatus) {
               //if ($("#txtBarCode").val() != "") {
               //有数据
               //alert(data);
               var dataObj;
               try {
                   dataObj = eval(data);
                   if (dataObj == undefined || dataObj.length <= 0) {
                       //数据异常
                       $("#tbMainQuery thead").html("");
                       $("#tbMainQuery tbody").html("");
                       $("#Loading").css("visibility", "hidden");
                       $("#Msg").css("visibility", "visible");
                       $("#Msg").html("出库箱不存在，请检查!");
                       //$("#txtBarCode").select();
                       $("#txtTrayNO").select();
                       return;
                   }
                   $("#tbMainQuery thead").html("");
                   $("#tbMainQuery tbody").html("");
                   trString = "<tr>"
                   trString += "<td>条码</td>";
                   trString += "<td>单位</td>";
                   trString += "<td>生产日期</td>";
                   trString += "<td>数量</td>";
                   trString += "</tr>"
                   $("#tbMainQuery thead").append(trString);
                   var trString = "";
                   for (var index in dataObj) {
                       trString = "<tr>"
                       trString += "<td>" + dataObj[index]['Barcode'] + "</td>";
                       trString += "<td>" + dataObj[index]['Unit'] + "</td>";
                       trString += "<td>" + dataObj[index]['ProductDate'] + "</td>";
                       trString += "<td>" + dataObj[index]['Qty'] + "</td>";
                       trString += "</tr>"
                       if (trString != "<tr></tr>")
                           $("#tbMainQuery tbody").append(trString);

                   }
                   var color = "#ffeab3"
                   $("#tbMainQuery tr:odd td").css("background-color", color);  //改变偶数行背景色
                   /* 把背景色保存到属性中 */
                   $("#tbMainQuery tr:odd").attr("bg", color);
                   $("#tbMainQuery tr:even").attr("bg", "#fff");
                   $("#Loading").css("visibility", "hidden");
                   //$("#btnUnLoad").select();
                   //RF_LoadUnLoad();
                   if (confirm("您确认取消当前出库箱装载吗？") == false) {
                       $("#Loading").css("visibility", "hidden");
                       $("#Msg").css("visibility", "visible");
                       $("#Msg").html("本次操作已取消！");
                       $("#txtTrayNO").focus();
                       $("#txtTrayNO").select();
                       return;
                   }
                   RF_LoadUnLoad();
               }
               catch (exception) {
                   
                   $("#tbMainQuery thead").html("");
                   $("#tbMainQuery tbody").html("");
                   $("#Loading").css("visibility", "hidden");
                   $("#Msg").css("visibility", "visible");
                   $("#Msg").html(data);
                   //$("#txtBarCode").select();
                   $("#txtTrayNO").select();
               }
           }
        )
    }
    function UnLoad() {
        $("#SuccessMsg").css("visibility", "hidden");
        $("#SuccessMsg").html("");
        $("#Msg").css("visibility", "hidden");
        $("#Msg").html("");
        if ($("#txtTrayNO").val() == "") {
            $("#Loading").css("visibility", "hidden");
            $("#Msg").css("visibility", "visible");
            $("#Msg").html("出库箱不能为空！");
            $("#txtTrayNO").focus();
            return;
        }
        if (confirm("您确认取消当前出库箱装载吗？") == false) {
            $("#Loading").css("visibility", "hidden");
            $("#Msg").css("visibility", "visible");
            $("#Msg").html("本次操作已取消！");
            $("#txtTrayNO").focus();
            $("#txtTrayNO").select();
            return;
        }
        RF_LoadUnLoad();
    }
    function RF_LoadUnLoad() {
        //if (confirm("您确认取消当前出库箱装载吗？") == false) {
        //    $("#Loading").css("visibility", "hidden");
        //    $("#Msg").css("visibility", "visible");
        //    $("#Msg").html("本次操作已取消！");
        //    $("#txtTrayNO").focus();
        //    $("#txtTrayNO").select();
        //    return;
        //}
        $("#Loading").css("visibility", "visible");
        $("#SuccessMsg").css("visibility", "hidden");
        $("#SuccessMsg").html("");
        $("#Msg").css("visibility", "hidden");
        $("#Msg").html("");
        var url = "/Load/RF_LoadUnLoad";
        var param = SetParmas();
        $.post(url, param, function (data, txtStatus) {
            if (data != "") {
                $("#Loading").css("visibility", "hidden");
                $("#Msg").css("visibility", "visible")
                $("#Msg").html(data);
                $("#txtTrayNO").select();
            }
            else {
                $("#Loading").css("visibility", "hidden");
                $("#SuccessMsg").html("操作成功！");
                $("#SuccessMsg").css("visibility", "visible");
                $("#txtTrayNO").val("");
                $("#txtTrayNO").focus();
            }
        });
    }

    ///////////////////////////////////////////////////////////////////
    function Pause(obj, iMinSecond) {
        if (window.eventList == null) window.eventList = new Array();
        var ind = -1;
        for (var i = 0; i < window.eventList.length; i++) {
            if (window.eventList[i] == null) {
                window.eventList[i] = obj;
                ind = i;
                break;
            }
        }
        if (ind == -1) {
            ind = window.eventList.length;
            window.eventList[ind] = obj;
        }
        setTimeout("GoOn(" + ind + ")", iMinSecond);
    }
    function GoOn(ind) {
        var obj = window.eventList[ind];
        window.eventList[ind] = null;
        if (obj.NextStep) obj.NextStep();
        else obj();
    }
    function GetUrlPara(paraName) {
        var sUrl = location.href;
        var sReg = "(?:\\?|&){1}" + paraName + "=([^&]*)"
        var re = new RegExp(sReg, "gi");
        re.exec(sUrl);
        return RegExp.$1;
    }
    ///////////////////////////////////////////////////////////////////
</script>

