@{
    ViewBag.Title = "出库复检";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<input id="hdselRfidDrives" type="hidden" value="@ViewBag.selRfidDrives" />

<div class="box">
    <table cellpadding="0" cellspacing="1">
        <tr>
            <td class="title">出库箱码</td>
            <td class="content">
                <input id="txtTrayNO" name="txtTrayNO" type="text" class="tdInput" />
            </td>
        </tr>
        <tr>
            <td class="title">公司</td>
            <td class="content" id="lblShipper"></td>
        </tr>
        <tr>
            <td class="title">门店</td>
            <td class="content" id="lblStore"></td>
        </tr>
        <tr>
            <td class="title">商品数量</td>
            <td>
                <table cellpadding="0" cellspacing="0">
                <tr>
                    <td class="content" id="lblGoodsQty"style="width:50px"></td>
                    <td style="width:55px;word-wrap: break-word !important; word-break: break-all !important;">标签数量</td>
                    <td class="content" id="lblRfidQty"></td>
                </tr>
                </table>
            </td>
        </tr>
        <tr>
            <td class="title">选择设备</td>
            <td class="content">
                <select id="selRfidDrivers"></select>

                    <input type="button" value="连接" id="btnConnect" onclick="onRfidConnect()" ; />
                    @*<button id="btnConnect" onclick="onRfidConnect()">连接</button>*@
</td>
        </tr>
    </table>
</div>
<div class="btn">
    <input type="button" value="清空" id="btnClear" onclick="ClearRfid()" ; />
    <input type="button" value="读取(F8)" id="btnRead" onclick="ReadRfid()" ; />
    <input type="button" value="提交(F9)" id="btnOK" onclick="CratesRfidCheck()" ; />
</div>
@*<style>
        .RFIDList table {
            background-color: #bbd9f5;
            width: 100%;
            border-collapse: collapse;
            font-size: 80%;
        }

            .RFIDList table td {
                font-size: 12px;
                border: solid 1px #0094ff;
                padding: 5px;
                word-break: keep-all;
                white-space: nowrap;
            }
    </style>*@
<div class="RFIDList" >
    <table id="tbMainQuery">
        <thead>
            <tr>

            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>
<br />
<div class="RFIDList">
    <table id="tbDetailQuery">
        <thead>
            <tr></tr>
        </thead>
        <tbody></tbody>
    </table>
</div>
<script type="text/javascript">
    $(document).ready(function () {
        $("#txtTrayNO").keypress(function (e) {
            if (e.which == 13) {
                ValidateTrayNO();
            }
        });
        $("#selRfidDrivers").keypress(function (e) {
            if (e.which == 13) {
                onRfidConnect();
            }
        });
        $(document).keydown(function (e) {
            var elem = e.srcElement || e.target;
            if (e.which == 118)//F7
            {
                ClearRfid();
            }
            else if (e.which == 119)//F8
            {
                ReadRfid();
            }
            else if (e.which == 120)//F9
            {
                CratesRfidCheck();
            }
        });

        FillDrivers();
        $("#txtTrayNO").focus();

    });
    function FillDrivers() {
        var list = $("#hdselRfidDrives").val();//.split(',');
        //var options = "";
        //for(var i in list){
        //    options += "<option>" + list[i] + "</option>";
        //}
        $("#selRfidDrivers").html(list);
    }
    //连接或断开设备
    function onRfidConnect() {
        RfidData = null;
        var bConnected = $("#btnConnect").val() != "连接" ? true : false;
        $("#Loading").css("visibility", "visible");
        $("#Msg").css("visibility", "visible");
        if (!bConnected) {
            $("#Msg").html("正在连接设备，请稍候...");
        } else {
            $("#Msg").html("正在断开设备，请稍候...");
        }
        $("#btnConnect").attr("disabled", true);
        $("#selRfidDrivers").attr("disabled", true);
        var url = "/CratesRFID/ConnectDriver";
        var params = {
            "bConnected": bConnected,
            "ipAddr": $("#selRfidDrivers").val()
        };
        $.post(url, params, function (data, txtStatus) {
            if (data != "") {
                //失败
                $("#Loading").css("visibility", "hidden");
                $("#Msg").css("visibility", "visible");
                $("#Msg").html(data);
                if (!bConnected) {
                    $("#btnConnect").removeAttr("disabled");
                    $("#selRfidDrivers").removeAttr("disabled");
                }
                $("#btnConnect").focus();
            }
            else {
                //通过
                $("#Loading").css("visibility", "hidden");
                $("#Msg").css("visibility", "visible");
                if (!bConnected) {
                    $("#Msg").html("设备连接成功！");
                    $("#btnConnect").val("断开");
                    $("#btnRead").focus();

                } else {
                    $("#Msg").html("设备已断开连接！");
                    $("#btnConnect").val("连接");
                    $("#selRfidDrivers").removeAttr("disabled");
                    $("#btnConnect").focus();
                }
            }
            $("#btnConnect").removeAttr("disabled");
        })
    }
    //清空RFID
    function ClearRfid() {

        $("#Loading").css("visibility", "visible");
        $("#Msg").css("visibility", "visible");
        $("#Msg").html("正在清空数据，请稍候...");
        url = "/CratesRFID/ClearRfid";
        var params = { "TrayNO": $("#txtTrayNO").val() };
        $.post(url, params, function (data, txtStatus) {
            ShowTrayRFID(data);
        })
    }
    //读取RFID
    function ReadRfid() {
        if ($("#btnConnect").val() == "连接") {
            alert("请先连接RFID设备！");
            $("#btnConnect").focus();
            return;
        }
        $("#tbMainQuery thead").html("");
        $("#tbMainQuery tbody").html("");
        $("#tbDetailQuery thead").html("");
        $("#tbDetailQuery tbody").html("");
        $("#lblRfidQty").html("");//获取标签总数
        $("#Loading").css("visibility", "visible");
        $("#Msg").css("visibility", "visible");
        $("#Msg").html("正在读取数据，请稍候...");
        url = "/CratesRFID/ReadRfid";
        var params = { "TrayNO": $("#txtTrayNO").val() };
        $.post(url, params, function (data, txtStatus) {
            ShowTrayRFID(data);
        })
    }

    //效验一下托盘号
    function ValidateTrayNO() {
        $("#Loading").css("visibility", "visible");
        $("#Msg").css("visibility", "hidden")
        $("#Msg").html("");
        $("#lblShipper").html("");
        $("#lblStore").html("");
        $("#lblGoodsQty").html("");
        $("#lblRfidQty").html("");
        $("#tbMainQuery thead").html("");
        $("#tbMainQuery tbody").html("");
        $("#tbDetailQuery thead").html("");
        $("#tbDetailQuery tbody").html("");
        var url = "/CratesRFID/ValidateTrayNO";
        var params = { "TrayNO": $("#txtTrayNO").val() };
        $.post(url, params, function (data, txtStatus) {
            try{
                var dataObj = eval(data);
                //效验通过
                $("#Loading").css("visibility", "hidden");
                $("#Msg").css("visibility", "hidden");
                $("#lblShipper").html(dataObj[0]['Shipper']);
                $("#lblStore").html(dataObj[0]['Store']);
                $("#lblGoodsQty").html(dataObj[0]['Qty']);
                if ($("#btnConnect").val() == "连接") {
                    $("#selRfidDrivers").focus();
                } else {
                    $("#btnRead").focus();
                }
                url = "/CratesRFID/ShowTrayRFID";
                params = { "TrayNO": $("#txtTrayNO").val() };
                $.post(url, params, function (data, txtStatus) {
                    ShowTrayRFID(data);
                })
            } catch (exception) {
                //效验失败
                $("#Loading").css("visibility", "hidden");
                $("#Msg").css("visibility", "visible");
                $("#Msg").html(data);
            }
        })
    }
    function ShowTrayRFID(data) {
        try {
            $("#tbMainQuery thead").html("");
            $("#tbMainQuery tbody").html("");
            $("#lblRfidQty").html("");//获取标签总数
            $("#tbDetailQuery thead").html("");
            $("#tbDetailQuery tbody").html("");

            //读取完成
            $("#Loading").css("visibility", "hidden");
            $("#Msg").css("visibility", "hidden");
            var dataObj = eval(data);
            var GoodsQty = 0;
            var RfidQty = 0;
            var InvalidQty = 0;
            var trString = "<tr>"
            //trString += "<td>条码</td>";
            trString += "<td><b><a href='#' onclick=QueryRfidDetail(0)>条码</a><b/></td>";
            trString += "<td><b>集货<b/></td>";
            trString += "<td><b>有效<b/></td>";
            trString += "<td><b>无效<b/></td>";
            trString += "<td><b>商品名称<b/></td>";
            trString += "</tr>"
            $("#tbMainQuery thead").append(trString);
            trString = "";
            for (var index in dataObj) {
                GoodsQty += dataObj[index]['GoodsQty'];
                RfidQty += dataObj[index]['RfidQty'];
                InvalidQty += dataObj[index]['InvalidQty']
                trString = "<tr>"
                //trString += "<td>" + dataObj[index]['Barcode'] + "</td>";
                trString += "<td><a href='#' onclick=QueryRfidDetail('" + dataObj[index]['GoodsID'] + "')>" + dataObj[index]['Barcode'] + "</a></td>";
                trString += "<td>" + dataObj[index]['GoodsQty'] + "</td>";
                trString += "<td>" + dataObj[index]['RfidQty'] + "</td>";
                trString += "<td>" + dataObj[index]['InvalidQty'] + "</td>";
                trString += "<td style='word-wrap: break-word !important; word-break: break-all !important;'>" + dataObj[index]['GoodsName'] + "</td>";
                trString += "</tr>"
                if (trString != "<tr></tr>")
                    $("#tbMainQuery tbody").append(trString);

            }
            $("#lblRfidQty").html(RfidQty + InvalidQty);//获取标签总数
            trString = "<tr><td>合计：" + dataObj.length + "</td><td>" + GoodsQty + "</td><td>" + RfidQty + "</td><td>" + InvalidQty + "</td><td></td></tr>";
            $("#tbMainQuery tbody").append(trString);
            var color = "#ffeab3"
            $("#tbMainQuery tr:odd td").css("background-color", color);  //改变偶数行背景色
            /* 把背景色保存到属性中 */
            $("#tbMainQuery tr:odd").attr("bg", color);
            $("#tbMainQuery tr:even").attr("bg", "#fff");
            $("#Loading").css("visibility", "hidden");

        } catch (exception) {
            //读取失败
            $("#Loading").css("visibility", "hidden");
            $("#Msg").css("visibility", "visible");
            $("#Msg").html(data);
        }
    }
    //提交数据
    function CratesRfidCheck() {
        $("#Loading").css("visibility", "visible");
        $("#Msg").css("visibility", "hidden")
        $("#Msg").html("");
        var url = "/CratesRFID/CratesRfidCheck";
        var params = { "TrayNO": $("#txtTrayNO").val() };
        $.post(url, params, function (data, txtStatus) {
            if (data == "") {
                //通过
                $("#Loading").css("visibility", "hidden");
                $("#Msg").css("visibility", "visible");
                $("#Msg").html("操作成功！");
                $("#txtTrayNO").focus();
                $("#txtTrayNO").select();
            } else {
                //失败
                $("#Loading").css("visibility", "hidden");
                $("#Msg").css("visibility", "visible");
                $("#Msg").html(data);
            }
        })
    }
    //查询商品RFID明细
    function QueryRfidDetail(GoodsID) {
        if (GoodsID == 'null') {
            GoodsID = -1;
        }
        $("#tbDetailQuery thead").html("");
        $("#tbDetailQuery tbody").html("");
        $("#Loading").css("visibility", "visible");
        $("#Msg").css("visibility", "hidden")
        $("#Msg").html("");
        var url = "/CratesRFID/QueryRfidDetail";
        var params = {
            "TrayNO": $("#txtTrayNO").val(),
            "GoodsID": GoodsID
        };
        $.post(url, params, function (data, txtStatus) {
            try {
                var dataObj = eval(data);
                //返回成功
                $("#Loading").css("visibility", "hidden");
                $("#Msg").css("visibility", "hidden");
                $("#tbDetailQuery thead").html("");
                $("#tbDetailQuery tbody").html("");

                var trString = "<tr>"
                trString += "<td><b>RFID<b/></td>";
                trString += "<td><b>状态<b/></td>";
                trString += "<td><b>条码<b/></td>";
                trString += "</tr>"
                $("#tbDetailQuery thead").append(trString);
                trString = "";
                for (var index in dataObj) {
                    trString = "<tr>"
                    trString += "<td>" + dataObj[index]['RFID'] + "</td>";
                    trString += "<td>" + dataObj[index]['InvalidMsg'] + "</td>";
                    trString += "<td>" + dataObj[index]['Barcode'] + "</td>";
                    trString += "</tr>"
                    if (trString != "<tr></tr>")
                        $("#tbDetailQuery tbody").append(trString);

                }
                trString = "<tr><td>合计：" + dataObj.length + "</td><td></td><td></td></tr>";
                $("#tbDetailQuery tbody").append(trString);
                var color = "#ffeab3"
                $("#tbDetailQuery tr:odd td").css("background-color", color);  //改变偶数行背景色
                /* 把背景色保存到属性中 */
                $("#tbDetailQuery tr:odd").attr("bg", color);
                $("#tbDetailQuery tr:even").attr("bg", "#fff");
            } catch (exception) {
                //效验失败
                $("#Loading").css("visibility", "hidden");
                $("#Msg").css("visibility", "visible");
                $("#Msg").html(data);
            }
        })
    }
</script>

