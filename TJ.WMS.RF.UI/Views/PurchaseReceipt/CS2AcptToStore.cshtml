@{
    ViewBag.Title = "二步越库收货分播";
    Layout = "~/Views/Shared/_LayoutDetail.cshtml";
    string ToDay = DateTime.Today.ToString("yyyy-MM-dd");
}
@using TJ.WMS.RF.UI.Models
@model TJ.WMS.RF.UI.Models.PurchaseReceiptModels
<script src="@Url.Content("~/My97DatePicker/WdatePicker.js")" type="text/javascript"></script>
<div class="box">
<input id="hdBillCode" type="hidden" value="@Html.Encode(ViewData["BillCode"])" />
<input id="hdCaseUnit" type="hidden" value="" />
<input id="hdShelfLife" type="hidden" value="" />
<input id="hdToDay" type="hidden" value="@ToDay" />
    @*<input id="hdisCaseAcpt" type="hidden" value="" />*@
    <input id="hdIsAuto" type="hidden" value="0" />
    <input id="hdBackCaseProductDate" type="hidden" value="1" />
<table cellspacing="1" cellpadding="0">
    <tr>
    <td colspan="2" style="background-color:#c8e4fc; text-align:center;"> @Html.Encode(ViewData["BillCode"])</td>
  </tr>
  <tr>
    <td colspan="2" style="background-color:#c8e4fc; text-align:center;">
      <span id="lblGoodsName"></span>
    </td>
  </tr>
  <tr>
    <td colspan="2" id="DcacptQty" style="background-color:#c8e4fc; text-align:center;">
    订货：<span id="lblOrderQty"></span> 已收：<span id="lblTraySumQty"></span></td>
  </tr>
    <tr>
       <td class="title">商品条码</td>
       <td class="content"><input type="text"  name="txtBarcode" id="txtBarcode" class="tdInput"  /></td>
    </tr>

   <tr>
       <td class="title" id="lblProductDate">生产日期</td>
       <td class="content"><input type="text"  name="txtProductDate" id="txtProductDate" class="tdInput"  /></td>
    </tr>
    <tr>
       <td class="title" id="lblEffectiveDate">到期日期</td>
       <td class="content"><input type="text"  name="txtEffectiveDate" id="txtEffectiveDate" class="tdInput"  /></td>
    </tr>
    <tr>
        <td class="title">托盘编码</td>
        <td class="content"><input type="text" name="txtTrayNO" id="txtTrayNO" class="tdInput" /></td>
    </tr>
    <tr>
       <td class="title">收货数量</td>
       <td class="content">
         <input type="text"  name="txtQty" id="txtQty" class="tdInput" style = "width: 50px"
                       onKeypress="return (/[\d.]/.test(String.fromCharCode(event.keyCode)))" 
             onafterpaste="this.value=this.value.replace(/\D/g,'')" value=""/>个
       </td>
    </tr>
</table>
</div>
 <div class="btn"><input  type="button" value="保存(F8)" id="btnSave" onclick="Save()" /> 
 <input  type="button" id="btnOver" onclick="Over()"   value="收货完成(F9)"/>
     <input type="button" id="btnIsAuto" onclick="IsAuto()" value="连收(开)" style="background-color:rgb(0, 116, 189)"></div> 

<script type="text/javascript">
    var isComplete = false;
    $(document).ready(function () {
        if ($("#hdisCaseAcpt").val == "0") {
        }
        $("#txtTrayNO").attr("disabled", "disabled");
        $("#txtProductDate").attr("disabled", "disabled");
        $("#txtEffectiveDate").attr("disabled", "disabled");
        $("#txtQty").attr("disabled", "disabled");
      
        $(document).keydown(function (e) {
            var elem = e.srcElement || e.target;
            if (e.which == 119)//F8
            {
                Save();
            }
            else if (e.which == 120)//F9
            {
                $("#btnOver").click();
            }
        });

        //===================商品条码=================================
        $("#txtBarcode").keypress(function (e) {
            if (e.which == 13) {
               // alert($("#txtQty").prop("disabled"))

                isComplete = false;
                ValidateBarCode();
            }
        }).blur();

        // ======================托盘编码=====================================
        $("#txtTrayNO").keypress(function (e) {
            if (e.which == 13) {

                ValidateTrayNO();

            }
        }).blur();
        //=======================生产日期==================
        $("#txtProductDate").keypress(function (e) {
            if (e.which == 13) {
                ValidateProductDate();
            }
        }).blur();
        //==============================================
        $("#txtProductDate").change(function () {
            if ($("#txtProductDate").val() != "") {
                var url = "/PurchaseReceipt/DateAdd";
                var params = { "date": $("#txtProductDate").val(),
                    "time": $("#hdShelfLife").val()
                };
                $.post(url, params, function (data, txtStatus) {
                    if (data != "") {
                        $("#txtEffectiveDate").val(data);
                    }
                }
          )
            }
        })
        //=============================================
        $("#txtEffectiveDate").keypress(function (e) {
            if (e.which == 13) {
                ValidateEffectiveDate();
            }
        }).blur();
        //==============================================
        $("#txtQty").keypress(function (e) {
            if (e.which == 13) {
               Save();
            }
        }).blur();
        //==============================================
   
        $("#txtBarcode").focus();
    });

    function SetParams() {
        var params = {
            "model.OrderNO": $("#hdBillCode").val()
        }
        return params;
    }

    //================商品条码验证==================
    function ValidateBarCode(isFirst) {
        if ($("#hdIsAuto").val() != "0") {
            $("#txtTrayNO").attr("disabled", "");
            $("#txtTrayNO").focus();
            $("#txtTrayNO").select();
            return;
        }
        $("#Loading").css("visibility", "visible");
        $("#lblGoodsName").html("");
        $("#lblOrderQty").text("");
        $("#lblTraySumQty").text("");
        $("#Msg").html("");
        $("#Msg").css("visibility", "hidden");
        var jqobj = $("#txtBarcode");
        var url = "/PurchaseReceipt/ValidateCS2ToStoreBarCode";
        var params = {
            "Barcode": $("#txtBarcode").val(),
            "OrderNO": $("#hdBillCode").val(),
            "TrayNO": $("#txtTrayNO").val()
        };
        $.post(url, params, function (data, textStatus) {
            if (data != "") {
                var dataObj;
                try {
                    dataObj = eval(data);
                    if (dataObj != undefined) {
                        if (dataObj.length <= 0) { return false; }
                        $("#lblOrderQty").text(dataObj[0].OrderQty);
                        $("#lblTraySumQty").text(dataObj[0].TraySumQty);
                        $("#hdCaseUnit").val(dataObj[0].CaseUnits);
                        $("#hdShelfLife").val(dataObj[0].ShelfLife);
                        $("#lblUnit").text(dataObj[0].Unit);
                        $("#lblGoodsName").text(dataObj[0].GoodsName);
                        //$("#txtCaseQty").val(dataObj[0].AcptCaseQty);
                        //$("#txtQty").val(dataObj[0].AcptQty);
                        // $("#txtQty2").val(dataObj[0].Qty2);
                        $("#txtQty").val(dataObj[0].CaseUnits);
                        $("#txtProductDate").val(dataObj[0].ProductDate);
                        $("#txtEffectiveDate").val(dataObj[0].EffectiveDate);
                        $("#hdBackCaseProductDate").val(dataObj[0].BackCaseProductDate);//0.不反算；1.反算
                       
                            if (dataObj[0].ShelfLife == "0") {
                                $("#lblProductDate").text("收货日期");
                                //$("#txtProductDate").val(formatDate(new Date()));
                                $("#txtProductDate").val($("#hdToDay").val());
                                $("#txtEffectiveDate").val("");
                                if (isFirst == undefined) {
                                    $("#txtProductDate").attr("disabled", "");
                                    $("#txtEffectiveDate").attr("disabled", "disabled");
                                }
                               
                            }
                            else {
                                $("#lblProductDate").text("生产日期");
                                //$("#txtProductDate").attr("disabled", "");
                                //$("#txtEffectiveDate").attr("disabled", "");
                                if (isFirst == undefined) {
                                    $("#txtProductDate").attr("disabled", "");
                                    $("#txtEffectiveDate").attr("disabled", "disabled");
                                }
                            }
                        

                        $("#Loading").css("visibility", "hidden");
                        if (!isComplete) {
                            $("#Msg").css("visibility", "hidden");
                            $("#Msg").html("");
                        }
                        if (isFirst == undefined) {
                            $("#txtProductDate").focus();
                            $("#txtProductDate").select();
                        }
               
                    }
                    else {
                        $("#Msg").css("visibility", "hidden");
                        $("#Msg").css("visibility", "visible");
                        $("#Msg").html(data);
                        $("#txtBarcode").focus();
                        $("#txtBarcode").select();
                        return false;
                    }
                }
                catch (exception) {
                    $("#Loading").css("visibility", "hidden");
                    $("#Msg").css("visibility", "visible")
                    $("#Msg").html(data);
                    event.returnValue = false;
                    $("#txtBarcode").focus();
                    $("#txtBarcode").select();
                    return false;
                }
            }
            else {
                $("#Loading").css("visibility", "hidden");
                $("#Msg").html("");
                $("#Msg").css("visibility", "hidden");
                $("#txtProductDate").focus();
                $("#txtProductDate").select();
                return true;
            }
        }
    );
    }
    //========================
    function ValidateTrayNO() {
        if ($("#hdIsAuto").val() == "0") {
            $("#txtQty").attr("disabled", "disabled");
            Save();
            return;
        }
        else {
            $("#Loading").css("visibility", "visible");
            $("#Msg").html("");
            $("#Msg").css("visibility", "hidden");

            var jqobj = $("#txtTrayNO");
            var url = "/PurchaseReceipt/ValidateCS2ToStoreTrayNO"
            var params = {
                "TrayNO": jqobj.val(),
                "Barcode": $("#txtBarcode").val(),
                "OrderNO": $("#hdBillCode").val(),
                //"model.StoreNO": $("#txtStoreNO").val()
            };
            $.post(url, params, function (data, textStatus) {
                if (data != "") {
                    var dataObj;
                    try {
                        dataObj = eval(data);
                        if (dataObj != undefined) {
                            if (dataObj.length <= 0) { return false; }
                            $("#lblOrderQty").text(dataObj[0].OrderQty);
                            $("#lblTraySumQty").text(dataObj[0].TraySumQty);
                            $("#hdCaseUnit").val(dataObj[0].CaseUnits);
                            $("#hdShelfLife").val(dataObj[0].ShelfLife);
                            $("#lblUnit").text(dataObj[0].Unit);
                            $("#lblGoodsName").text(dataObj[0].GoodsName);
                            //$("#txtCaseQty").val(dataObj[0].AcptCaseQty);
                            $("#txtQty").val(dataObj[0].AcptQty);
                           // $("#txtQty2").val(dataObj[0].Qty2);
                            $("#txtProductDate").val(dataObj[0].ProductDate);
                            $("#txtEffectiveDate").val(dataObj[0].EffectiveDate);
                            if (dataObj[0].ShelfLife == "0") {
                                $("#lblProductDate").text("收货日期");
                                //$("#txtProductDate").val(formatDate(new Date()));
                                $("#txtProductDate").val($("#hdToDay").val());
                                $("#txtEffectiveDate").val("");
                                $("#txtProductDate").attr("disabled", "disabled");
                                $("#txtEffectiveDate").attr("disabled", "disabled");
                               // $("#txtCaseQty").attr("disabled", "");
                                //$("#txtCaseQty").focus()
                                //$("#txtCaseQty").select()
                            }
                            else {
                                $("#lblProductDate").text("生产日期");
                                $("#txtProductDate").attr("disabled", "");
                                //$("#txtEffectiveDate").attr("disabled", "");
                                //$("#txtProductDate").attr("disabled", "disabled");
                                $("#txtEffecteeiveDate").attr("disabled", "disabled");
                                $("#txtProductDate").focus();
                                $("#txtProductDate").select();
                            }
                            $("#Loading").css("visibility", "hidden");
                            $("#Msg").css("visibility", "hidden");
                            $("#Msg").html("");
                            $("#txtQty").attr("disabled", "");
                            $("#txtQty").focus()
                            $("#txtQty").select()

                        }
                        else {
                            $("#Loading").css("visibility", "hidden");
                            $("#Msg").css("visibility", "visible");
                            $("#Msg").html(data);
                            $("#txtTrayNO").focus();
                            $("#txtTrayNO").select();
                            return false;
                        }
                    }
                    catch (exception) {
                        $("#Loading").css("visibility", "hidden");
                        $("#Msg").css("visibility", "visible")
                        $("#Msg").html(data);
                        event.returnValue = false;
                        $("#txtTrayNO").focus();
                        $("#txtTrayNO").select();
                        return false;
                    }
                }
                else {
                    $("#Loading").css("visibility", "hidden");
                    $("#Msg").html("");
                    $("#Msg").css("visibility", "hidden");
                    $("#txtCaseQty").attr("disabled", "");
                    $("#txtCaseQty").focus();
                    return true;
                }
            }
                );
        }
      
    }
    //============================================
    function ValidateProductDate() {
        if ($("#txtProductDate").val() == "") {
            if ($("#hdShelfLife").val() != "0") {
                $("#txtEffectiveDate").attr("disabled", "");
                $("#txtEffectiveDate").focus();
                $("#txtEffectiveDate").select();
            }
            return;
        }
        $("#Loading").css("visibility", "visible");
        $("#Msg").css("visibility", "hidden");
        $("#Msg").html("");
        var dt = $("#txtProductDate").val();
        dt = MyFormatDate(dt);
        $("#txtProductDate").val(dt);
        if ($("#Msg").html() != "") {
            $("#Loading").css("visibility", "hidden");
            return;
        }
        var jqobj = $("#txtProductDate");
        var url = "/PurchaseReceipt/ValidateCS2ProductDate";
        var params = { "ProductDate": $("#txtProductDate").val(),
            "time": $("#hdShelfLife").val()
        }
        $.post(url, params, function (data, textStatus) {
            if (data != "") {
                $("#Loading").css("visibility", "hidden");
                $("#Msg").css("visibility", "visible");
                $("#Msg").html(data);
                return false;
            }
            else {
                $("#Loading").css("visibility", "hidden");
                $("#Msg").css("visibility", "hidden");
                $("#Msg").html("");
                var date = StrToDate($("#txtProductDate").val());
                var day = parseInt($("#hdShelfLife").val());
               
                //如果不考虑保质期
                if ($("#hdShelfLife").val() != "0") {
                    $("#txtEffectiveDate").val(AddDays(date, day));
                    $("#txtEffectiveDate").attr("disabled", "");
                    $("#txtEffectiveDate").focus();
                    $("#txtEffectiveDate").select();
                } else {
                    $("#txtEffectiveDate").attr("disabled", "disabled");
                    if ($("#hdIsAuto").val() == "0") {
                        $("#txtTrayNO").attr("disabled", "");
                        $("#txtTrayNO").focus();
                        $("#txtTrayNO").select()
                    }
                    else {
                        $("#txtQty").focus();
                        $("#txtQty").select()
                    }

                }
                //alert(day);
                return true;
            }
        }
          );
    }
    //=======================================
    function ValidateEffectiveDate() {

        $("#Loading").css("visibility", "visible");
        $("#Msg").html("");
        $("#Msg").css("visibility", "hidden");
        var dt = $("#txtEffectiveDate").val();
        dt = MyFormatDate(dt);
        $("#txtEffectiveDate").val(dt);
        if ($("#Msg").html() != "") {
            $("#Loading").css("visibility", "hidden");
            return;
        }
        ////////////////////////////////////////////
        //$("#txtEffectiveDate").text(formatDate(StrToDate($("#txtEffectiveDate").val())));
        var url = "/PurchaseReceipt/ValidateCS2EffectiveDate";
        var params = { "EffectiveDate": $("#txtEffectiveDate").val(),
            "shelfLife": $("#hdShelfLife").val()
        };
        $.post(url, params, function (data, textStatus) {
            if (data != "") {
                $("#Loading").css("visibility", "hidden");
                $("#Msg").html(data);
                $("#Msg").css("visibility", "visible");
                //$("#txtEffectiveDate").focus();
                $("#txtEffectiveDate").select();
                return false;
            }
            else {
                $("#Loading").css("visibility", "hidden");
                $("#Msg").html("");
                $("#Msg").css("visibility", "hidden");
                //SetInputDisabled(5);
                if ($("#hdBackCaseProductDate").val() == "1") {
                    var date = StrToDate($("#txtEffectiveDate").val());
                    var day = -parseInt($("#hdShelfLife").val());
                    $("#txtProductDate").val(AddDays(date, day));
                }
                if ($("#hdIsAuto").val() == "0") {
                    $("#txtTrayNO").attr("disabled", "");
                    $("#txtTrayNO").focus();
                    $("#txtTrayNO").select()
                }
                else {
                    $("#txtQty").focus();
                    $("#txtQty").select()
                }

 
                return true;
            }
        }
           );
    }

    function Save() {
       
        $("#Loading").css("visibility", "visible");
        $("#Msg").html("");
        $("#Msg").css("visibility", "hidden");
        var url = "/PurchaseReceipt/CS2AcptConfirm2";
        var params = {
            "TrayNO": $("#txtTrayNO").val(),
            "Barcode": $("#txtBarcode").val(),
            "OrderNO": $("#hdBillCode").val(),
           // "StoreNO": $("#txtStoreNO").val(),
            "EffectiveDate": $("#txtEffectiveDate").val(),
            "ProductDate": $("#txtProductDate").val(),
            "Qty": $("#txtQty").val(),
            "shelfLife": $("#hdShelfLife").val(),

        };
        $.post(url, params, function (data, textStatus) {

            if (data != "") {
                if (data.indexOf("散数托盘返回填数量") != -1 ) {
                    $("#txtQty").val("");
                    $("#Loading").css("visibility","hidden");
                    $("#Msg").html(data);
                    $("#Msg").css("visibility", "visible");
                    $("#txtQty").attr("disabled", "");
                    $("#txtQty").val(data.substring(9));
                    $("#txtQty").select();
                    return;
                }
                if (data.indexOf("收货数量大于散数托盘最大数量") != -1) {
                    $("#txtQty").val("");
                    $("#Loading").css("visibility", "hidden");
                    $("#Msg").html(data);
                    $("#Msg").css("visibility", "visible");
                    $("#txtQty").attr("disabled", "");
                    $("#txtQty").val(data.substring(14));
                    $("#txtQty").select();
                    return;
                }
                if ($("#hdIsAuto").val() != "0") {
                    if (data != "0" && data != "") {
                        $("#Loading").css("visibility", "hidden");
                        $("#Msg").html(data);
                        $("#Msg").css("visibility", "visible");
                        $("#txtQty").focus();
                        $("#txtQty").select();
                        return
                    }
                    $("#Loading").css("visibility", "hidden");
                    $("#Msg").html("修改成功");
                    $("#Msg").css("visibility", "visible");
                    $("#txtTrayNO").focus();
                    $("#txtTrayNO").select();

                    return;
                }
                if (data == "0")//商品还没有收完
                {
                    var sum = 0;
                    isComplete = true;
                    ValidateBarCode("noFirst"); //重新计算总收货量
                    $("#Loading").css("visibility", "hidden");
                    $("#txtProductDate").attr("disabled", "");
                    $("#txtEffectiveDate").attr("disabled", "");
                    $("#Msg").html($("#txtTrayNO").val() + "操作成功！");//数量：" + $("#txtQty").val());
                    $("#txtQty").val("");
                    $("#txtTrayNO").val("");
                    $("#Msg").css("visibility", "visible");
                    $("#txtTrayNO").attr("disabled", "");
                    $("#txtTrayNO").focus();
                  
                }
                else {
                    $("#Loading").css("visibility", "hidden");
                    $("#Msg").html(data);
                    $("#Msg").css("visibility", "visible");
                    
                    if (!$("#txtQty").is("disabled")) {
                        $("#txtQty").focus();
                        $("#txtQty").select();
                    }
                    else {
                        $("#txtTrayNO").focus();
                        $("#txtTrayNO").select();
                        $("#txtQty").val(dataObj[0].CaseUnits);
                        //$("#txtProductDate").attr("disabled", "");
                    }
                }
            }
            else {
                //商品收货完成

                isComplete = true;
                $("#Loading").css("visibility", "hidden");
                $("#Msg").html("操作成功！");
                $("#Msg").css("visibility", "visible");

                $("#lblOrderQty").text("");
                $("#lblTraySumQty").text("");

                //清空数据
                $("#lblGoodsName").text("");
                $("#txtBarcode").val("");
                $("#txtTrayNO").val("")
                $("#txtEffectiveDate").val("");
                $("#txtProductDate").val("");
                $("#hdShelfLife").val("");
                //$("#txtCaseQty").val("0");
                $("#txtQty").val("");
                //$("#txtQty2").val("0");
                //20140726

                $("#txtBarcode").focus();
                $("#txtTrayNO").attr("disabled", "disabled");
                $("#txtProductDate").attr("disabled", "disabled");
                $("#txtEffectiveDate").attr("disabled", "disabled");
               // $("#txtCaseQty").attr("disabled", "disabled");
                //$("#txtQty2").attr("disabled", "disabled");
            }
        }
       );
    }
    //============================
    function Over() {
        var url = "/PurchaseReceipt/Over";
        var params = { "TrayNO": $("#txtTrayNO").val(),
            "Barcode": $("#txtBarcode").val(),
            "OrderNO": $("#hdBillCode").val(),
            "EffectiveDate": $("#txtEffectiveDate").val(),
            "ProductDate": $("#txtProductDate").val(),
            "Qty": $("#txtQty").val(),
            "shelfLife": $("#hdShelfLife").val()
        };
        $.post(url, params, function (data, txtStatus) {
            if (data == "") {
                window.location.href = '/PurchaseReceipt';
            }
            else {
                $("#Msg").html(data);
                $("#Msg").css("visibility", "visible");
            }
        });
    }

    function IsAuto() {
        var IsAuto = $("#hdIsAuto").val();
        if (IsAuto == "0") {
            $("#hdIsAuto").val("1");
          //$("#txtCaseQty").val("0");
          //$("#txtQty2").val("0");
          //$("#txtCaseQty").attr("disabled", "disabled");
            $("#txtQty").attr("disabled", "");
            //$("#txtQty").attr("disabled", "disabled");
            $("#txtQty").val("");
            $("#txtProductDate").val( "");
            $("#txtEffectiveDate").val("");
            $("#txtProductDate").attr("disabled", "");
            $("#txtProductDate").attr("disabled", "");
            $("#txtEffectiveDate").attr("disabled", "");
            $("#btnIsAuto").val("连收（关)")
            $("#btnIsAuto").css('background-color', '#ff0000')
            $("#txtBarcode").focus();
        }
        else {
            window.location.reload();
            //$("#hdIsAuto").val("0");
            //$("#txtCaseQty").val("0");
            //$("#txtQty2").val("0");
            //$("#txtCaseQty").attr("disabled", "disabled");
            //$("#txtQty2").attr("disabled", "disabled");
            //$("#btnIsAuto").val("连收(开)");
            //$("#btnIsAuto").css('background-color', 'rgb(0, 116, 189)')
            //$("#txtBarcode").val("");
            //$("#lblOrderQty").text("");
            //$("#lblTraySumQty").text("");
            ////清空数据
            //$("#lblFullQty").text("");
            //$("#lblGoodsName").text("");
            //$("#txtTrayNO").val("")
            //$("#txtEffectiveDate").val("");
            //$("#txtProductDate").val("");
            //$("#hdShelfLife").val("");
            //$("#txtCaseQty").val("");
            //$("#txtQty").val("");
            //$("#txtBarcode").focus();
        }
       
    }
    //======================================
    function formatDate(d) {
        var month = d.getMonth() + 1;
        var day = d.getDate();
        if (month < 10) {
            month = "0" + month;
        }
        if (day < 10) {
            day = "0" + day;
        }
        return d.getFullYear() + "-" + month + "-" + day;
    }
    //============字符串格式化成时间类型===========
    function MyFormatDate(str) {
        try {
            $("#Msg").css("visibility", "hidden");
            $("#Msg").html("");
            var str1 = str
            if (str == "") return;
            if (str.length == 8) {
                str = str.substr(0, 4) + "-" + str.substr(4, 2) + "-" + str.substr(6, 2);

                if (!isDateString(str)) {
                    $("#Msg").html("日期格式错误");
                    $("#Msg").css("visibility", "visible");
                    return str1;
                } else
                    return str;
            }
            else {
                if (!isDateString(str)) {
                    $("#Msg").html("日期格式错误");
                    $("#Msg").css("visibility", "visible");
                }
                return str1;
            }

        }
        catch (exception) {
            $("#Msg").html("日期格式错误");
            $("#Msg").css("visibility", "visible");
            return str1;
        }
    }

    function isDateString(sDate) {
        var iaMonthDays = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31]
        var iaDate = new Array(3)
        var year, month, day

        if (arguments.length != 1) return false
        iaDate = sDate.toString().split("-")
        if (iaDate.length != 3) return false
        if (iaDate[1].length > 2 || iaDate[2].length > 2) return false

        year = parseFloat(iaDate[0])
        month = parseFloat(iaDate[1])
        day = parseFloat(iaDate[2])

        if (year < 1900 || year > 2100) return false
        if (((year % 4 == 0) && (year % 100 != 0)) || (year % 400 == 0)) iaMonthDays[1] = 29;
        if (month < 1 || month > 12) return false
        if (day < 1 || day > iaMonthDays[month - 1]) return false
        return true
    }

    function StrToDate(str) {

        str = str.replace(/-/g, "/");
        var date = new Date(str);
        return date;
    }
    // 增加天  
    function AddDays(date, value) {
        date.setDate(date.getDate() + value);
        return formatDate(date);
    }          
</script>